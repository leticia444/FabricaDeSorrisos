@using System.Security.Claims
@model FabricaDeSorrisos.Web.Models.ProdutoDetalhesViewModel
@{
    ViewData["Title"] = Model.Produto.Nome;
}

<nav aria-label="breadcrumb" class="py-3 bg-light mb-4 border-bottom">
    <div class="container">
        <ol class="breadcrumb mb-0 small fw-bold">
            <li class="breadcrumb-item"><a asp-action="Index" class="text-decoration-none text-muted">Home</a></li>
            <li class="breadcrumb-item"><a asp-action="Busca" asp-route-termoBusca="@Model.Produto.Categoria" class="text-decoration-none text-muted">@Model.Produto.Categoria</a></li>
            <li class="breadcrumb-item active text-primary" aria-current="page">@Model.Produto.Nome</li>
        </ol>
    </div>
</nav>

<div class="container">
    @* --- PARTE SUPERIOR (Fundo Branco Padrão) --- *@
    <div class="row g-5">

        @* COLUNA DA IMAGEM *@
        <div class="col-md-6">
            @* Container Quadrado Perfeito (aspect-ratio: 1/1) *@
            <div class="bg-white p-4 rounded-5 shadow-sm border position-relative text-center d-flex align-items-center justify-content-center overflow-hidden" style="aspect-ratio: 1/1;">
                <img src="@(Model.Produto.ImagemUrl ?? "https://placehold.co/500?text=Sem+Foto")"
                     class="img-fluid zoom-effect"
                     alt="@Model.Produto.Nome"
                     style="object-fit: contain; max-height: 90%; max-width: 90%;">

                <span class="position-absolute top-0 start-0 m-4 badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 rounded-pill px-3 py-2">
                    @Model.Produto.Marca
                </span>
            </div>
        </div>

        @* COLUNA DOS DETALHES *@
        <div class="col-md-6">
            <h5 class="text-muted text-uppercase small fw-bold mb-2">@ViewBag.SubCategoria</h5>
            <h1 class="fw-bold mb-3 display-6" style="color: #333;">@Model.Produto.Nome</h1>

            <div class="mb-3 text-warning d-flex align-items-center">
                <span class="fw-bold fs-5 me-2 text-dark">@Model.MediaNota.ToString("0.0")</span>
                @for (int i = 1; i <= 5; i++)
                {
                    if (i <= Math.Round(Model.MediaNota))
                    {
                        <i class="bi bi-star-fill"></i>
                    }
                    else
                    {
                        <i class="bi bi-star text-secondary opacity-25"></i>
                    }
                }
                <span class="text-muted small ms-2">(@Model.TotalAvaliacoes avaliações)</span>
            </div>

            <div class="mb-4">
                <h2 class="display-4 fw-bold text-primary mb-0">R$ @Model.Produto.Preco.ToString("N2")</h2>
                <span class="text-muted fs-5">em até <strong>6x de R$ @((Model.Produto.Preco / 6).ToString("N2"))</strong> sem juros</span>
            </div>

            @if (Model.Produto.Estoque > 0)
            {
                <div class="alert alert-success d-inline-block py-2 px-3 rounded-3 mb-4 border-0 bg-success bg-opacity-10 text-success fw-bold">
                    <i class="bi bi-check-circle-fill me-2"></i> Estoque disponível (@Model.Produto.Estoque un.)
                </div>
            }
            else
            {
                <div class="alert alert-danger d-inline-block py-2 px-3 rounded-3 mb-4">
                    <i class="bi bi-x-circle-fill me-2"></i> Produto Esgotado
                </div>
            }

            @* BOTÃO DE ADICIONAR E FAVORITOS *@
            <div class="d-flex gap-2 mb-4 align-items-stretch">
                @if (Model.Produto.Estoque > 0)
                {
                    @* Botão Verde Claro com Carrinho e Texto "adicionar" *@
                    <button class="btn btn-cart-icon flex-grow-1 shadow-sm d-flex align-items-center justify-content-center gap-2" onclick="adicionarAoCarrinho(this, @Model.Produto.Id)">
                        <i class="bi bi-cart-fill fs-4"></i> <span class="fw-bold fs-5 text-lowercase">adicionar</span>
                    </button>
                }
                else
                {
                    <button class="btn btn-secondary btn-lg rounded-pill px-5 fw-bold flex-grow-1 disabled">
                        AVISE-ME QUANDO CHEGAR
                    </button>
                }

                @* Botão de Favorito *@
                <button class="btn btn-outline-danger rounded-circle btn-favorito d-flex align-items-center justify-content-center"
                        style="width: 55px;"
                        onclick="toggleFavorito(this, @Model.Produto.Id)"
                        data-id="@Model.Produto.Id"
                        data-auth="@User.Identity.IsAuthenticated.ToString().ToLower()"
                        title="Adicionar aos Favoritos">
                    <i class="bi bi-heart fs-4"></i>
                </button>
            </div>

            @* CAIXAS DE FRETE E GARANTIA *@
            <div class="card border-0 bg-light rounded-4 mb-4">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <div class="bg-white p-2 rounded-circle text-primary"><i class="bi bi-truck fs-4"></i></div>
                        <div>
                            <h6 class="fw-bold mb-0">Frete Grátis</h6>
                            <small class="text-muted">Para compras acima de R$ 299,00</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="bg-white p-2 rounded-circle text-success"><i class="bi bi-shield-check fs-4"></i></div>
                        <div>
                            <h6 class="fw-bold mb-0">Compra Garantida</h6>
                            <small class="text-muted">Receba o produto ou seu dinheiro de volta</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* --- FAIXA CINZA CLARA (bg-light) PARA AS ABAS E INFORMAÇÕES --- *@
<div class="tabs-bg-wrapper mt-5">
    <div class="container">
        <ul class="nav nav-pills mb-4 gap-3 justify-content-center" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active rounded-pill px-4 border shadow-sm" id="pills-desc-tab" data-bs-toggle="pill" data-bs-target="#pills-desc" type="button" role="tab">Descrição</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link rounded-pill px-4 border shadow-sm" id="pills-specs-tab" data-bs-toggle="pill" data-bs-target="#pills-specs" type="button" role="tab">Características</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link rounded-pill px-4 border shadow-sm" id="pills-reviews-tab" data-bs-toggle="pill" data-bs-target="#pills-reviews" type="button" role="tab">Avaliações (@Model.TotalAvaliacoes)</button>
            </li>
        </ul>

        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="pills-desc" role="tabpanel">
                <div class="bg-white p-5 rounded-4 border shadow-sm text-secondary lh-lg">
                    <h4 class="fw-bold text-dark mb-3">Sobre o Produto</h4>
                    <p>@Model.Produto.Descricao</p>
                    <p>Ideal para estimular a criatividade e proporcionar horas de diversão. Fabricado com materiais de alta qualidade e segurança certificada.</p>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-specs" role="tabpanel">
                <div class="bg-white p-5 rounded-4 border shadow-sm">
                    <h4 class="fw-bold text-dark mb-3">Ficha Técnica</h4>
                    <table class="table table-borderless">
                        <tbody>
                            <tr class="border-bottom">
                                <td class="text-muted w-25">Marca</td>
                                <td class="fw-bold">@Model.Produto.Marca</td>
                            </tr>
                            <tr class="border-bottom">
                                <td class="text-muted">Faixa Etária</td>
                                <td class="fw-bold">@ViewBag.FaixaEtaria</td>
                            </tr>
                            <tr class="border-bottom">
                                <td class="text-muted">Personagem</td>
                                <td class="fw-bold">@(ViewBag.Personagem ?? "Nenhum")</td>
                            </tr>
                            <tr class="border-bottom">
                                <td class="text-muted">Categoria</td>
                                <td class="fw-bold">@Model.Produto.Categoria</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-reviews" role="tabpanel">
                <div class="row">
                    <div class="col-md-8 mx-auto">
                        <div class="bg-white border shadow-sm p-4 rounded-4 mb-4 text-center">
                            <h1 class="fw-bold display-4 text-warning">@Model.MediaNota.ToString("0.0")</h1>
                            <div class="mb-2">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    if (i <= Math.Round(Model.MediaNota))
                                    {
                                        <i class="bi bi-star-fill text-warning fs-4"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-star text-secondary opacity-25 fs-4"></i>
                                    }
                                }
                            </div>
                            <p class="text-muted">Baseado em @Model.TotalAvaliacoes avaliações</p>
                        </div>

                        @if (User.Identity.IsAuthenticated)
                        {
                            <div class="card border shadow-sm mb-5 bg-white rounded-4">
                                <div class="card-body p-4">
                                    <h5 class="fw-bold mb-3">Deixe sua opinião</h5>
                                    <form asp-action="EnviarFeedback" method="post">
                                        <input type="hidden" name="brinquedoId" value="@Model.Produto.Id" />
                                        <div class="mb-3">
                                            <label class="form-label d-block text-muted small">Sua Nota:</label>
                                            <div class="rating">
                                                <input type="radio" name="nota" value="5" id="5"><label for="5">☆</label>
                                                <input type="radio" name="nota" value="4" id="4"><label for="4">☆</label>
                                                <input type="radio" name="nota" value="3" id="3"><label for="3">☆</label>
                                                <input type="radio" name="nota" value="2" id="2"><label for="2">☆</label>
                                                <input type="radio" name="nota" value="1" id="1"><label for="1">☆</label>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <textarea name="comentarioTexto" class="form-control bg-light" rows="3" placeholder="O que você achou do produto?"></textarea>
                                        </div>
                                        <div class="text-end">
                                            <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">Enviar Avaliação</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info text-center rounded-pill py-3 bg-white border shadow-sm">
                                <i class="bi bi-person-lock me-2"></i>
                                <a asp-controller="Account" asp-action="Login" class="fw-bold text-decoration-underline">Faça login</a> para avaliar este produto.
                            </div>
                        }

                        <div class="d-flex flex-column gap-3">
                            @if (Model.Comentarios.Any())
                            {
                                var currentUserIdStr = User.FindFirstValue("UsuarioSistemaId");
                                int currentUserId = string.IsNullOrEmpty(currentUserIdStr) ? 0 : int.Parse(currentUserIdStr);
                                @foreach (var c in Model.Comentarios)
                                {
                                    <div class="card bg-white border shadow-sm rounded-4">
                                        <div class="card-body p-4 position-relative">
                                            @if (User.Identity.IsAuthenticated && c.UsuarioId == currentUserId)
                                            {
                                                <form asp-action="ExcluirComentario" method="post" class="position-absolute top-0 end-0 m-3" onsubmit="return confirm('Tem certeza que deseja apagar seu comentário?');">
                                                    <input type="hidden" name="comentarioId" value="@c.Id" />
                                                    <input type="hidden" name="brinquedoId" value="@Model.Produto.Id" />
                                                    <button type="submit" class="btn btn-sm btn-outline-danger border-0" title="Apagar meu comentário">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            }
                                            <div class="d-flex justify-content-between mb-2">
                                                <div><h6 class="fw-bold mb-0 text-primary">@c.Usuario?.NomeCompleto</h6></div>
                                                <small class="text-muted pe-4">@c.DataComentario.ToString("dd/MM/yyyy")</small>
                                            </div>
                                            <p class="mb-0 text-secondary">@c.Texto</p>
                                            @if (!string.IsNullOrEmpty(c.Resposta))
                                            {
                                                <div class="bg-light p-3 rounded-3 mt-3 border-start border-4 border-warning">
                                                    <div class="d-flex align-items-center mb-1 text-warning fw-bold small">
                                                        <i class="bi bi-patch-check-fill me-1"></i> Resposta da Loja
                                                    </div>
                                                    <p class="mb-0 small text-dark">@c.Resposta</p>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-chat-square-text fs-1 mb-2 d-block opacity-50"></i>
                                    <p>Ainda não há comentários. Seja o primeiro a avaliar!</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* --- VOLTA PARA O FUNDO BRANCO - PRODUTOS RELACIONADOS --- *@
<div class="container">
    @if (Model.Relacionados.Any())
    {
        <div class="mt-5 pt-4">
            <h3 class="fw-bold mb-4 text-center" style="color: #000269;">Quem viu, também gostou 🧸</h3>
            <div class="row row-cols-1 row-cols-md-4 g-4 pb-5">
                @foreach (var item in Model.Relacionados)
                {
                    <div class="col d-flex justify-content-center">
                        @* CARD NO MESMO FORMATO DA HOME/BUSCA *@
                        <div class="card product-card-wireframe shadow-custom-blue border-0 position-relative rounded-5 overflow-hidden p-3" style="width: 276px; height: 450.07px;">

                            <div class="position-relative text-center mb-2">
                                <a asp-action="Detalhes" asp-route-id="@item.Id" class="d-block text-decoration-none">
                                    <img src="@(item.ImagemUrl ?? "https://placehold.co/200?text=Foto")" class="img-fluid" alt="@item.Nome" style="height: 180px; object-fit: contain;">
                                </a>
                                <button class="btn btn-light rounded-circle position-absolute top-0 end-0 m-0 shadow-sm btn-favorito"
                                        onclick="toggleFavorito(this, @item.Id)"
                                        data-id="@item.Id"
                                        data-auth="@User.Identity.IsAuthenticated.ToString().ToLower()">
                                    <i class="bi bi-heart fs-5 text-secondary"></i>
                                </button>
                            </div>

                            <div class="card-body p-0 d-flex flex-column text-start">
                                <div class="text-warning mb-1" style="font-size: 0.8rem;">
                                    <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
                                </div>
                                <h5 class="fw-bold text-dark mb-1 fs-6 text-truncate">@item.Nome</h5>

                                <div class="mb-2 d-flex flex-wrap gap-2 align-items-center">
                                    <small class="text-muted d-block">@item.Marca</small>
                                </div>

                                <div class="mt-auto">
                                    <h4 class="fw-bold text-dark mb-0">R$ @item.Preco.ToString("N2")</h4>
                                    <p class="text-muted" style="font-size: 0.75rem; margin-bottom: 10px;">
                                        ou 10x R$ @((item.Preco / 10).ToString("N2")) s/juros
                                    </p>
                                    <button class="btn btn-success-custom w-100 rounded-4 py-2" onclick="adicionarAoCarrinho(this, @item.Id)">
                                        <i class="bi bi-cart-fill me-1"></i> adicionar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    /* ZOOM DA IMAGEM QUADRADA */
    .zoom-effect {
        transition: transform 0.5s ease;
        cursor: zoom-in;
    }

        .zoom-effect:hover {
            transform: scale(1.1);
        }

    /* BOTÃO VERDE CLARO (ADICIONAR) */
    .btn-cart-icon {
        background-color: #39b54a; /* Verde claro da referência */
        color: white;
        border-radius: 12px;
        transition: 0.3s;
        border: none;
        padding: 12px;
    }

        .btn-cart-icon:hover {
            background-color: #2e933c;
            color: white;
        }

    /* FAIXA CINZA DAS ABAS */
    .tabs-bg-wrapper {
        background-color: #f8f9fa; /* Mesma cor da caixa de frete */
        width: 100vw;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        padding: 60px 0;
    }

    /* CORES DOS BOTÕES DAS ABAS */
    .nav-pills .nav-link {
        background-color: #ffffff; /* Fundo branco inativo */
        color: #555;
    }

        .nav-pills .nav-link.active {
            background-color: #00bfff; /* Azul Claro Fábrica ativo */
            color: white;
        }

    /* Estrelas do Formulário */
    .rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
    }

        .rating input {
            display: none;
        }

        .rating label {
            cursor: pointer;
            width: 30px;
            font-size: 30px;
            color: #ccc;
            transition: color 0.2s;
        }

            .rating label:before {
                content: '\2605';
            }

            .rating input:checked ~ label,
            .rating label:hover,
            .rating label:hover ~ label {
                color: #ffd700;
            }
</style>